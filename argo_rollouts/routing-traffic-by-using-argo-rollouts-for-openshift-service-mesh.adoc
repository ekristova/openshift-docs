:_mod-docs-content-type: ASSEMBLY
include::_attributes/common-attributes.adoc[]
[id="routing-traffic-by-using-argo-rollouts-for-openshift-service-mesh"]
= Routing traffic by using Argo Rollouts for OpenShift Service Mesh
:context: routing-traffic-by-using-argo-rollouts-for-openshift-service-mesh

toc::[]

Argo Rollouts in Red Hat OpenShift GitOps support various traffic management mechanisms such as OpenShift Routes and Istio-based OpenShift Service Mesh. 

The choice for selecting a traffic manager to be used with Argo Rollouts depends on the existing traffic management solution that you are using to deploy cluster workloads. For example, Red Hat OpenShift Routes provides basic traffic management functionality and does not require the use of a sidecar container. However, Red Hat OpenShift Service Mesh provides more advanced routing capabilities by using Istio but does require the configuration of a sidecar container. 

You can use OpenShift Service Mesh to split traffic between two application versions:

* *Canary version*: A new version of an application where you gradually route the traffic.
* *Stable version*: The current version of an application. After the canary version is stable and has all the user traffic directed to it, it becomes the new stable version. The previous stable version is discarded.

The Istio-support within Argo Rollouts uses the Gateway and VirtualService resources to handle traffic routing.

*Gateway*: You can use a Gateway to manage inbound and outbound traffic for your mesh. The gateway is the entry point of OpenShift Service Mesh and handles traffic requests sent to an application.

*VirtualService*: VirtualService defines traffic routing rules and the percentage of traffic that goes to underlying services, such as the stable and canary services. 

For example, in a sample deployment scenario, in the initial instance 100% of the traffic is directed towards the stable version of the application. The application is running as expected, and no additional attempts are made to deploy a new version.

image::446_OpenShift_Service_Mesh_Argo_Rollouts_0724_1.png[100% of traffic in the stable version of the application]

However, after deploying a new version of the application, Argo Rollouts creates a new canary deployment based on the new version of the application and routes some percentage of traffic to that new version.

When using Service Mesh, Argo Rollouts automatically modifies the VirtualService resource to control the traffic split percentage between the stable and canary application versions. In the following diagram, 20% of traffic is sent to the canary application version after the first promotion and then 80% is sent to the stable version by the stable service.

image::446_OpenShift_Service_Mesh_Argo_Rollouts_0724_2.png[80% of traffic in the stable version and 20% in the canary version]

[id="prerequisites_{context}"]
== Prerequisites
* You have logged in to the {OCP} cluster as an administrator.
* You have installed xref:../installing_gitops/installing-openshift-gitops.adoc#installing-openshift-gitops[{gitops-title}] on your {OCP} cluster.
* You have installed xref:../argo_rollouts/using-argo-rollouts-for-progressive-deployment-delivery.adoc#gitops-creating-rolloutmanager-custom-resource_using-argo-rollouts-for-progressive-deployment-delivery[Argo Rollouts] on your {OCP} cluster.
* You have installed the xref:../installing_gitops/installing-argocd-gitops-cli.adoc#installing-argocd-gitops-cli[{gitops-title} CLI] on your system.
* You have installed the xref:../argo_rollouts/using-argo-rollouts-for-progressive-deployment-delivery.adoc#gitops-installing-argo-rollouts-cli-on-linux_using-argo-rollouts-for-progressive-deployment-delivery[Argo Rollouts CLI] on your system.
* Ensure you have installed the link:https://docs.openshift.com/container-platform/latest/service_mesh/v2x/installing-ossm.html[OpenShift Service Mesh] operator on the cluster and configured the link:https://docs.openshift.com/container-platform/latest/service_mesh/v2x/ossm-create-smcp.html[ServiceMeshControlPlane].

// Configuring Argo Rollouts to route traffic by using OpenShift Routes
include::modules/gitops-configure-rollout-route-traffic-using-openshift-service-mesh.adoc[leveloffset=+1]

[role="_additional-resources"]
[id="additional-resources_{context}"]
== Additional resources
* xref:../gitops_cli_argocd/configuring-argocd-gitops-cli.adoc#configuring-argocd-gitops-cli[Configuring the GitOps CLI]
* xref:../argo_rollouts/argo-rollouts-overview.adoc#gitops-argo-rollouts-cli-overview_argo-rollouts-overview[Argo Rollouts CLI overview]
* link:https://cloud.redhat.com/blog/trying-out-argo-rollouts-in-openshift-gitops-1.9/[Argo Rollouts tech preview limitations]